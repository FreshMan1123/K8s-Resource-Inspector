# Go测试框架和文件组织

## Go的测试系统

### 测试文件命名和组织约定

1. **测试文件命名**
   - 测试文件以 `_test.go` 结尾
   - 通常与被测试的代码放在同一个包中
   - 也可以单独放在 `test` 目录中，形成独立的测试包

2. **测试函数命名**
   - 测试函数必须以 `Test` 开头
   - 后跟首字母大写的单词，如 `TestNodeInspection`
   - 必须接受 `*testing.T` 类型的参数

3. **测试数据组织**
   - 测试数据通常放在 `testdata` 目录下
   - Go工具链特殊处理 `testdata` 目录，编译时会忽略它
   - 测试可以相对路径访问测试数据文件

### 运行测试

当执行 `go test ./test -v` 命令时:

1. Go工具会扫描 `./test` 目录下所有 `*_test.go` 文件
2. 识别所有以 `Test` 开头且接收 `*testing.T` 参数的函数
3. 为每个测试函数创建新的 `testing.T` 实例并执行它
4. `-v` 参数启用详细模式，显示每个测试的运行结果

## K8s-Resource-Inspector 项目中的测试结构

在我们的项目中:

1. **测试目录组织**
   - 测试文件位于 `code/test/` 目录下
   - 测试数据在 `code/test/testdata/` 目录中
   - 包含正常节点和高负载节点的JSON数据
   - 包含测试规则配置文件 `rules_test.yaml`

2. **`node_inspect_test.go`测试文件**
   - 包含节点巡检功能的测试用例
   - 使用预定义的测试数据模拟节点状态
   - 使用规则引擎验证节点状态是否符合规则

3. **测试初始化与资源清理**
   - 使用 `TestMain(m *testing.M)` 函数进行全局测试设置和清理
   - 每个测试函数可以有自己的初始化和清理代码
   - 使用 `t.Cleanup()` 注册测试完成后的清理函数

## 编写有效的Go测试

1. **测试辅助函数**
   - 创建辅助函数减少重复代码
   - 辅助函数名可以不以 `Test` 开头
   - 例如用于加载测试数据或设置测试环境的函数

2. **表驱动测试**
   - Go中常用的测试模式，定义测试用例表并循环执行
   - 每个测试用例包含输入和期望输出
   - 便于添加新的测试场景，无需修改测试逻辑

3. **测试覆盖率**
   - 使用 `go test -cover` 查看测试覆盖率
   - 使用 `go test -coverprofile=coverage.out` 生成覆盖率报告
   - 使用 `go tool cover -html=coverage.out` 在浏览器中查看详细覆盖情况

4. **测试并发**
   - 使用 `t.Parallel()` 标记可并行执行的测试
   - 注意共享资源的并发访问问题
   - 适当使用同步原语保证测试的正确性 